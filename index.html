<!DOCTYPE html>
<html lang="it">
<head>
  <!--
  Personal Finance PWA
  Modifiche:
  - Pulsanti allineati all'interno delle sezioni.
  - Tabella responsive in Seleziona Mese.
  - Icona Condividi in Seleziona Mese;
  - Eliminazione transazioni per mese dal menu laterale.
  -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Finanze Personali Light</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f5f5f5; color: #333; }
    header { background: #0066cc; color: #fff; padding: 1rem; display: flex; justify-content: center; align-items: center; position: relative; }
    #menu-btn { position: absolute; left: 1rem; font-size: 1.5rem; background: none; border: none; color: #fff; cursor: pointer; }
    h1 { margin: 0; font-size: 1.5rem; }
    main { max-width: 600px; margin: auto; padding: 2rem; }
    section { background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 2rem; padding: 2rem; display: none; }
    section.active { display: block; }
    .flex { display: flex; align-items: center; gap: 1rem; width: 100%; margin-bottom: 1rem; }
    .flex > input { flex: 1; }
    form { display: grid; gap: 1rem; }
    input, select, button { padding: 0.75rem; font-size: 1rem; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9; }
    select { appearance: menulist-button; width: 100%; }
    input[type="date"] { appearance: none; background: #0066cc; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; table-layout: fixed; }
    th, td { padding: 0.5rem; border: 1px solid #ddd; text-align: left; }
    th { background: #eee; }
    .summary { font-weight: bold; margin-bottom: 1rem; }
    .delete-btn { background: none; border: none; color: #c00; cursor: pointer; font-size: 1.2rem; }
    #sidebar { position: fixed; top: 0; left: 0; width: 250px; height: 100%; background: #fff; box-shadow: 2px 0 5px rgba(0,0,0,0.2); transform: translateX(-100%); transition: transform 0.3s ease; z-index: 1000; padding: 1rem; }
    #sidebar.active { transform: translateX(0); }
    #sidebar ul { list-style: none; padding: 0; }
    #sidebar li { margin: 1rem 0; }
    #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); display: none; z-index: 500; }
    #overlay.active { display: block; }
    #month-preview { overflow-x: auto; }
  </style>
</head>
<body>
  <header>
    <button id="menu-btn">‚ò∞</button>
    <h1>üí∞ Finance</h1>
  </header>
  <div id="overlay"></div>
  <nav id="sidebar">
    <ul>
      <li><button id="link-dashboard">Dashboard</button></li>
      <li><button id="link-cats">Categorie</button></li>
      <li><button id="link-months">Visione Mese</button></li>
      <li>
        <select id="delete-month-select"></select>
        <button id="delete-tx-btn" class="delete-btn">üóëÔ∏è</button>
      </li>
    </ul>
  </nav>
  <main>
    <section id="dashboard-section" class="active">
      <h2>üìä Panoramica</h2>
      <div class="summary" id="balance-summary">Saldo: ‚Ç¨0.00</div>
      <div class="summary" id="expense-summary">Totale spese: ‚Ç¨0.00</div>
      <div class="flex">
        <input type="number" id="salary-input-dash" placeholder="Stipendio (‚Ç¨)" step="0.01" />
        <button id="save-salary-dash">Salva Stipendio</button>
      </div>
      <h3>‚ûï Aggiungi Transazione</h3>
      <form id="dash-tx-form">
        <input type="date" id="dash-date" required />
        <select id="dash-cat"></select>
        <input type="text" id="dash-desc" placeholder="Descrizione" required />
        <input type="number" id="dash-amt" placeholder="Importo (‚Ç¨)" step="0.01" required />
        <button type="submit">Aggiungi</button>
      </form>
      <h3>Spese per Categoria</h3>
      <table>
        <thead><tr><th>Categoria</th><th>Spesa (‚Ç¨)</th></tr></thead>
        <tbody id="dash-cat-list"></tbody>
      </table>
      <div class="flex" style="justify-content: space-between; margin-top:2rem;">
        <label for="dash-cat-select">Dettagli Categoria:</label>
        <select id="dash-cat-select"><option value="">Seleziona categoria</option></select>
      </div>
      <div id="dash-cat-detail"></div>
      <canvas id="pie-chart"></canvas>
      <div id="pie-msg" class="summary"></div>
    </section>
    <section id="cats-section">
      <h2>üé® Categorie</h2>
      <div class="flex">
        <input type="text" id="new-cat" placeholder="Nuova categoria" />
        <button id="add-cat-btn" style="background: #0066cc; color: #fff;">Aggiungi</button>
      </div>
      <ul id="cat-list"></ul>
    </section>
    <section id="months-section">
      <h2>üîç Seleziona Mese</h2>
      <div style="position: relative;">
        <select id="month-select"></select>
        <button id="share-months" style="position: absolute; right: 0; top: 0;">üîó</button>
      </div>
      <div id="month-preview" style="margin-top:1rem; display:none;">
        <div class="summary" id="balance-preview">Saldo: ‚Ç¨0.00</div>
        <div class="summary" id="expense-preview">Totale spese: ‚Ç¨0.00</div>
        <canvas id="pie-preview" style="margin-top:1rem;"></canvas>
        <table style="width:100%; margin-top:1rem;">
          <thead><tr><th>Data</th><th>Descrizione</th><th>‚Ç¨</th><th>Categoria</th></tr></thead>
          <tbody id="preview-tx-list"></tbody>
        </table>
      </div>
    </section>
    <section id="detail-section">
      <h2>üìà Dettaglio Mese</h2>
      <div class="summary" id="balance-detail">Saldo: ‚Ç¨0.00</div>
      <div class="summary" id="expense-detail">Totale spese: ‚Ç¨0.00</div>
      <table>
        <thead><tr><th>Data</th><th>Descrizione</th><th>‚Ç¨</th><th>Categoria</th></tr></thead>
        <tbody id="tx-list"></tbody>
      </table>
      <div id="cat-detail"></div>
      <canvas id="pie-detail"></canvas>
      <div id="detail-pie-msg" class="summary"></div>
    </section>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Sidebar toggle
    const menuBtn = document.getElementById('menu-btn');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    menuBtn.addEventListener('click', () => {
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
    });
    overlay.addEventListener('click', () => {
      sidebar.classList.remove('active');
      overlay.classList.remove('active');
    });
    // Data stores
    let txs = JSON.parse(localStorage.getItem('txs') || '[]');
    let cats = JSON.parse(localStorage.getItem('cats') || JSON.stringify(['Spesa','Trasporti','Divertimento']));
    let salaries = JSON.parse(localStorage.getItem('salaries') || '{}');
    const saveAll = () => {
      localStorage.setItem('txs', JSON.stringify(txs));
      localStorage.setItem('cats', JSON.stringify(cats));
      localStorage.setItem('salaries', JSON.stringify(salaries));
    };
    const getMonthKey = dateStr => {
      const d = new Date(dateStr);
      return `${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}`;
    };
    let pieChartInstance, previewPieInstance;
    function renderCats() {
      const list = document.getElementById('cat-list');
      const dashCat = document.getElementById('dash-cat');
      list.innerHTML = '';
      dashCat.innerHTML = '';
      cats.forEach(c => {
        const li = document.createElement('li');
        li.textContent = c;
        list.append(li);
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        dashCat.append(opt);
      });
    }
    function renderDashboard() {
      const m = getMonthKey(new Date());
      const filtered = txs.filter(t => getMonthKey(t.date) === m);
      const totalExp = filtered.reduce((sum,t) => sum + t.amt, 0);
      const salary = salaries[m] || 0;
      document.getElementById('balance-summary').textContent = `Saldo: ‚Ç¨${(salary-totalExp).toFixed(2)}`;
      document.getElementById('expense-summary').textContent = `Totale spese: ‚Ç¨${totalExp.toFixed(2)}`;
      const catMap = {};
      filtered.forEach(t => catMap[t.cat] = (catMap[t.cat]||0)+t.amt);
      document.getElementById('dash-cat-list').innerHTML = Object.entries(catMap).map(([c,v]) => `<tr><td>${c}</td><td>‚Ç¨${v.toFixed(2)}</td></tr>`).join('');
      const dashCatSelect = document.getElementById('dash-cat-select');
      dashCatSelect.innerHTML = '<option value="">Seleziona categoria</option>' +
        Object.keys(catMap).map(c => `<option value="${c}">${c}</option>`).join('');
      const labels = Object.keys(catMap);
      const data = Object.values(catMap);
      const colors = labels.map(l => JSON.parse(localStorage.getItem('catColors')||'{}')[l]||'#cccccc');
      const ctx = document.getElementById('pie-chart').getContext('2d');
      if(pieChartInstance) pieChartInstance.destroy();
      pieChartInstance = new Chart(ctx,{type:'pie',data:{labels,datasets:[{data,backgroundColor:colors}]}});
    }
    function renderMonths() {
      const sel = document.getElementById('month-select');
      const keys = Array.from(new Set(txs.map(t=>getMonthKey(t.date)))).sort().reverse();
      sel.innerHTML = '<option value="">Seleziona mese</option>' + keys.map(k=>`<option value="${k}">${k}</option>`).join('');
    }
    function renderDetail(m) {
      const filtered = txs.filter(t=>getMonthKey(t.date)===m);
      const total = filtered.reduce((s,t)=>s+t.amt,0);
      const salary = salaries[m]||0;
      document.getElementById('balance-preview').textContent = `Saldo: ‚Ç¨${(salary-total).toFixed(2)}`;
      document.getElementById('expense-preview').textContent = `Totale spese: ‚Ç¨${total.toFixed(2)}`;
      document.getElementById('preview-tx-list').innerHTML = filtered.map(t=>`<tr><td>${t.date}</td><td>${t.desc}</td><td>‚Ç¨${t.amt.toFixed(2)}</td><td>${t.cat}</td></tr>`).join('');
      const labels = [...new Set(filtered.map(t=>t.cat))];
      const data = labels.map(l=>filtered.filter(t=>t.cat===l).reduce((s,t)=>s+t.amt,0));
      const colors = labels.map(l => JSON.parse(localStorage.getItem('catColors')||'{}')[l]||'#cccccc');
      const ctx2 = document.getElementById('pie-preview').getContext('2d');
      if(previewPieInstance) previewPieInstance.destroy();
      previewPieInstance = new Chart(ctx2,{type:'pie',data:{labels,datasets:[{data,backgroundColor:colors}]}});
    }
    document.getElementById('delete-tx-btn').addEventListener('click',()=>{
      const sel = document.getElementById('delete-month-select').value;
      if(!sel) return alert('Seleziona un mese');
      if(!confirm(`Eliminare tutte le transazioni di ${sel}?`)) return;
      txs = txs.filter(t=>getMonthKey(t.date)!==sel);
      saveAll(); renderCats(); renderDashboard(); renderMonths();
    });
    document.getElementById('share-months').addEventListener('click',()=>{
      if(navigator.share) navigator.share({title:document.title,url:window.location.href}); else window.print();
    });
    function showSection(id){['dashboard-section','cats-section','months-section','detail-section'].forEach(s=>document.getElementById(s).classList.toggle('active',s===id));}
    document.getElementById('link-dashboard').addEventListener('click',()=>{showSection('dashboard-section');sidebar.classList.remove('active');overlay.classList.remove('active');});
    document.getElementById('link-cats').addEventListener('click',()=>{showSection('cats-section');sidebar.classList.remove('active');overlay.classList.remove('active');});
    document.getElementById('link-months').addEventListener('click',()=>{showSection('months-section');sidebar.classList.remove('active');overlay.classList.remove('active');});
    document.getElementById('save-salary-dash').addEventListener('click',()=>{const m=getMonthKey(new Date());salaries[m]=parseFloat(document.getElementById('salary-input-dash').value)||0;saveAll();renderDashboard();});
    document.getElementById('dash-tx-form').addEventListener('submit',e=>{e.preventDefault();txs.push({date:document.getElementById('dash-date').value,desc:document.getElementById('dash-desc').value,amt:parseFloat(document.getElementById('dash-amt').value),cat:document.getElementById('dash-cat').value});saveAll();e.target.reset();document.getElementById('dash-date').value=new Date().toISOString().slice(0,10);renderDashboard();renderMonths();});
    document.getElementById('add-cat-btn').addEventListener('click',()=>{const v=document.getElementById('new-cat').value.trim();if(v&&!cats.includes(v)){cats.push(v);saveAll();document.getElementById('new-cat').value='';renderCats();renderDashboard();renderMonths();}});
    document.getElementById('dash-cat-select').addEventListener('change',e=>{const sel=e.target.value;const detail=document.getElementById('dash-cat-detail');detail.innerHTML='';if(!sel)return;txs.filter(t=>getMonthKey(t.date)===getMonthKey(new Date())&&t.cat===sel).forEach(t=>{const li=document.createElement('li');li.textContent=`${t.date} - ‚Ç¨${t.amt.toFixed(2)}: ${t.desc}`;detail.append(li);});});
    document.getElementById('month-select').addEventListener('change',e=>{const m=e.target.value;if(!m)return document.getElementById('month-preview').style.display='none';renderDetail(m);document.getElementById('month-preview').style.display='';});
    window.addEventListener('load',()=>{document.getElementById('dash-date').value=new Date().toISOString().slice(0,10);renderCats();renderMonths();renderDashboard();showSection('dashboard-section');document.getElementById('delete-month-select').innerHTML='<option value="">Seleziona mese</option>'+Array.from(new Set(txs.map(t=>getMonthKey(t.date)))).sort().map(m=>`<option value="${m}">${m}</option>`).join('');});
    document.querySelector('main').addEventListener('click',()=>{sidebar.classList.remove('active');overlay.classList.remove('active');});
  </script>
</body>
</html>
